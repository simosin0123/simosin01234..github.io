<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºˆç®—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆFirebaseåŒæœŸãƒ»ã‚«ã‚¹ã‚¿ãƒ å¯¾å¿œï¼‰</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background: #F9FAFB; margin: 0; color: #222; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); color: white; padding: 30px 0; text-align: center; }
        h1 { font-size: 2.2em; font-weight: 700;}
        h2 { margin-top:1em;}
        .content, .auth-content { background: white; border-radius: 12px; box-shadow: 0 1px 5px rgba(0,0,0,0.08); padding: 30px;}
        .flex { display: flex; gap: 20px; flex-wrap: wrap;}
        .card { background: #F4F4FC; border-radius: 8px; padding: 18px; margin-bottom: 12px; border: 1px solid #E5E7EB;}
        .input-group { margin-bottom: 10px;}
        label { display: block; font-weight: 600; margin-bottom: 3px;}
        input[type=text],input[type=number],input[type=password],select {
            width: 100%; padding: 8px 12px; font-size: 1em;
            border-radius: 6px; border: 1.5px solid #D1D5DB; background: #fff; color: #222;
        }
        input:focus, select:focus { border-color: #7C3AED;}
        button {
            background: #4F46E5; color: white; border: none; padding: 8px 16px; border-radius: 6px;
            font-size: 1em; font-weight: 600; cursor: pointer; transition: background 0.2s;
        }
        button:hover { background: #4338CA;}
        .danger { background: #E11D48!important;}
        .success { background: #059669!important;}
        .secondary { background: #64748b!important;}
        .small { font-size:0.9em;}
        .tab-bar {display: flex; border-radius:12px; overflow:hidden; margin-bottom:12px;}
        .tab-btn {
            flex:1; background:#E0E7FF; color:#444; padding:14px; cursor:pointer; text-align:center; border:none; font-weight:500;
        }
        .tab-btn.active {background:#4F46E5; color:white;}
        .expense-list { max-height: 320px; overflow-y: auto;}
        .expense-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #E5E7EB;}
        .expense-item:last-child { border-bottom: none;}
        .expense-item strong { color: #7C3AED;}
        .delete-btn { background: #F43F5E; color: white; padding:4px 10px; font-size:0.95em; margin-left:8px;}
        .delete-btn:hover { background: #DC2626;}
        .edit-btn { background:#7C3AED; margin-left:5px;}
        .category-manage {display:flex;gap:5px;}
        .table {width:100%; border-collapse:collapse;}
        .table th,.table td {padding:8px; border-bottom:1px solid #E5E7EB; text-align:left;}
        .table th {background:#4F46E5; color:#fff;}
        .progress-bar { width:100%; height:10px; background:#E5E7EB; border-radius:6px; overflow:hidden;}
        .progress-fill {height:100%; background:linear-gradient(to right,#7C3AED,#4F46E5);}
        .alert { padding:12px; border-radius:6px; margin-bottom:8px; font-weight:500;}
        .alert-warning { background: #FEF3C7; color: #92400E;}
        .alert-success { background: #D1FAE5; color: #065F46;}
        .week-total-row { background:#c7d2fe!important; color:#1e293b; font-weight:bold;}
        @media (max-width:700px){
            .flex {flex-direction:column;}
            .content, .auth-content { padding: 12px;}
        }
    </style>
</head>
<body>
<header>
    <h1>ğŸ’° äºˆç®—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
    <p>ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸï¼†ãƒ•ãƒ«ã‚«ã‚¹ã‚¿ãƒ </p>
</header>
<!-- èªè¨¼ç”»é¢ -->
<div id="loginScreen" class="auth-content" style="max-width:400px;margin:2em auto; display:none;">
    <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
    <div class="input-group"><label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><input type="text" id="loginUsername"></div>
    <div class="input-group"><label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input type="password" id="loginPassword"></div>
    <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button class="secondary" onclick="showRegister()">æ–°è¦ç™»éŒ²</button>
</div>
<div id="registerScreen" class="auth-content" style="max-width:400px;margin:2em auto; display:none;">
    <h2>æ–°è¦ç™»éŒ²</h2>
    <div class="input-group"><label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label><input type="text" id="registerUsername"></div>
    <div class="input-group"><label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input type="password" id="registerPassword"></div>
    <div class="input-group"><label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label><input type="password" id="registerPasswordConfirm"></div>
    <button onclick="register()">ç™»éŒ²</button>
    <button class="secondary" onclick="showLogin()">æˆ»ã‚‹</button>
</div>
<!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª -->
<div id="mainApp" style="display:none;">
    <div class="container">
        <div style="text-align:right;">
            <span class="small">ãƒ­ã‚°ã‚¤ãƒ³ä¸­: <b id="currentUser"></b></span>
            <button class="secondary" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
        <!-- æœˆã®åˆ‡ã‚Šæ›¿ãˆãƒ»æœˆåˆè¨­å®š -->
        <div style="margin:18px 0;text-align:center;">
            <button onclick="changeMonth(-1)">â† å‰æœˆ</button>
            <span id="currentMonth" style="font-weight:bold;font-size:1.1em;"></span>
            <button onclick="changeMonth(1)">æ¬¡æœˆ â†’</button>
            <button class="success" onclick="goToToday()">ä»Šæœˆã¸</button>
            <button class="secondary" onclick="changeMonthStartDay()">æœˆã®é–‹å§‹æ—¥ã‚’è¨­å®š</button>
        </div>
        <!-- ã‚¿ãƒ– -->
        <div class="tab-bar">
            <button class="tab-btn active" onclick="showTab('summary')">æ¦‚è¦</button>
            <button class="tab-btn" onclick="showTab('income')">åå…¥</button>
            <button class="tab-btn" onclick="showTab('budget')">äºˆç®—</button>
            <button class="tab-btn" onclick="showTab('expense')">æ”¯å‡º</button>
            <button class="tab-btn" onclick="showTab('weekly')">é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</button>
            <button class="tab-btn" onclick="showTab('settings')">è¨­å®š</button>
        </div>
        <!-- æ¦‚è¦ -->
        <div class="content" id="summaryTab">
            <h2>æœˆæ¬¡ã‚µãƒãƒªãƒ¼</h2>
            <div class="flex">
                <div class="card" style="flex:1;"><h3>åå…¥</h3><p style="font-size:1.3em">Â¥<span id="totalIncome">0</span></p></div>
                <div class="card" style="flex:1;"><h3>äºˆç®—åˆè¨ˆ</h3><p style="font-size:1.3em">Â¥<span id="totalBudget">0</span></p></div>
                <div class="card" style="flex:1;"><h3>æ”¯å‡ºåˆè¨ˆ</h3><p style="font-size:1.3em">Â¥<span id="totalExpense">0</span></p></div>
                <div class="card" style="flex:1;" id="remainingCard"><h3>æ®‹é¡</h3><p style="font-size:1.3em">Â¥<span id="remainingBudget">0</span></p></div>
            </div>
            <h3>ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥æ”¯å‡ºçŠ¶æ³</h3>
            <table class="table"><thead>
                <tr><th>ã‚«ãƒ†ã‚´ãƒªãƒ¼</th><th>äºˆç®—</th><th>æ”¯å‡º</th><th>æ®‹é¡</th><th>é€²æ—</th></tr>
            </thead><tbody id="categorySummary"></tbody></table>
            <div id="alerts"></div>
        </div>
        <!-- åå…¥ -->
        <div class="content" id="incomeTab" style="display:none;">
            <h2>åå…¥è¨­å®š</h2>
            <div id="incomeList"></div>
            <button onclick="addIncomeCategory()">ï¼‹åå…¥é …ç›®è¿½åŠ </button>
        </div>
        <!-- äºˆç®— -->
        <div class="content" id="budgetTab" style="display:none;">
            <h2>äºˆç®—è¨­å®š</h2>
            <div>
                <h3>å›ºå®šè²» <button class="small" onclick="addBudgetCategory('fixed')">ï¼‹è¿½åŠ </button></h3>
                <div id="budgetFixed"></div>
                <h3>è²¯è“„ãƒ»ç©ç«‹ <button class="small" onclick="addBudgetCategory('saving')">ï¼‹è¿½åŠ </button></h3>
                <div id="budgetSaving"></div>
                <h3>å¤‰å‹•è²» <button class="small" onclick="addBudgetCategory('variable')">ï¼‹è¿½åŠ </button></h3>
                <div id="budgetVariable"></div>
            </div>
        </div>
        <!-- æ”¯å‡º -->
        <div class="content" id="expenseTab" style="display:none;">
            <h2>æ”¯å‡ºå…¥åŠ›</h2>
            <div class="flex">
                <div class="card" style="flex:2;">
                    <div class="input-group"><label>æ—¥ä»˜</label>
                        <input type="date" id="expenseDate">
                    </div>
                    <div class="input-group"><label>ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                        <select id="expenseCategory"></select>
                    </div>
                    <div class="input-group"><label>é‡‘é¡</label>
                        <input type="number" id="expenseAmount" placeholder="0">
                    </div>
                    <div class="input-group"><label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
                        <input type="text" id="expenseMemo">
                    </div>
                    <button onclick="addExpense()">æ”¯å‡ºã‚’è¿½åŠ </button>
                </div>
            </div>
            <h3>ä»Šæœˆã®æ”¯å‡ºä¸€è¦§</h3>
            <div class="expense-list" id="expenseList"></div>
        </div>
        <!-- é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ -->
        <div class="content" id="weeklyTab" style="display:none;">
            <h2>é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</h2>
            <table class="table"><thead>
                <tr>
                    <th>ã‚«ãƒ†ã‚´ãƒªãƒ¼</th>
                    <th>ç¬¬1é€±</th>
                    <th>ç¬¬2é€±</th>
                    <th>ç¬¬3é€±</th>
                    <th>ç¬¬4é€±</th>
                    <th>ç¬¬5é€±</th>
                    <th>æœˆåˆè¨ˆ</th>
                </tr>
            </thead>
            <tbody id="weeklyReport"></tbody>
            </table>
        </div>
        <!-- è¨­å®š -->
        <div class="content" id="settingsTab" style="display:none;">
            <h2>ã‚«ãƒ†ã‚´ãƒªãƒ»æœˆåˆè¨­å®š</h2>
            <div>
                <b>æœˆã®é–‹å§‹æ—¥ï¼š</b>
                <span id="currentStartDay"></span>
                <button onclick="changeMonthStartDay()">å¤‰æ›´</button>
            </div>
            <p>å„ã‚«ãƒ†ã‚´ãƒªãƒ»åå…¥åã®ç·¨é›†ãƒ»è¿½åŠ ãƒ»å‰Šé™¤ã¯å„ç”»é¢ã‹ã‚‰è¡Œãˆã¾ã™ã€‚</p>
            <button class="danger" onclick="resetAllData()">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
        </div>
    </div>
</div>
<!-- ===== SCRIPTæœ¬ä½“ï¼ˆè¶…é•·æ–‡ã®ãŸã‚æ¬¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§å…¨ã‚³ãƒ¼ãƒ‰é€ä¿¡ï¼‰ ===== -->
<script>
// ==== Firebaseè¨­å®šï¼ˆã“ã“ã‚’æ›¸ãæ›ãˆã¦ä½¿ã†ï¼‰ ====
const firebaseConfig = {
  apiKey: "AIzaSyDFnNNb5wTESyC6zdWgG3OoR1LVLr7Vc1o",
  authDomain: "josan-44288.firebaseapp.com",
  projectId: "josan-44288",
  storageBucket: "josan-44288.appspot.com",
  messagingSenderId: "844486822796",
  appId: "1:844486822796:web:320679767e0ad86355a4a9",
  measurementId: "G-KTJRYVCV87"
};
// ---- ã“ã“ã‚’è‡ªåˆ†ã®Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã«ï¼ ----

// FirebaseåˆæœŸåŒ–
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ========== å¤‰æ•°/å®šæ•° ==========
let data = {}; // æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿
let currentMonth = ""; // '2024-06'ãªã©
let currentUser = null;
let userUid = null;
const LOCAL_MONTH_KEY = "lastMonthKey";
const LOCAL_STARTDAY_KEY = "budgetAppStartDay";

// ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==========
function getMonthStartDay() {
    return parseInt(localStorage.getItem(LOCAL_STARTDAY_KEY) || "15");
}
function setMonthStartDay(d) {
    localStorage.setItem(LOCAL_STARTDAY_KEY, d);
    document.getElementById('currentStartDay').textContent = d + 'æ—¥';
}
function getMonthKey(date) {
    const d = new Date(date);
    let startDay = getMonthStartDay();
    if (d.getDate() < startDay) d.setMonth(d.getMonth() - 1);
    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
}
function getMonthRange(monthKey) {
    let [y, m] = monthKey.split("-").map(Number);
    let startDay = getMonthStartDay();
    const start = new Date(y, m - 1, startDay);
    const end = new Date(y, m, startDay - 1);
    return { start, end };
}
function getWeekNumber(date, monthKey) {
    const range = getMonthRange(monthKey);
    const daysSinceStart = Math.floor((date - range.start) / (1000 * 60 * 60 * 24));
    return Math.min(Math.floor(daysSinceStart / 7) + 1, 5);
}

// ========== FirebaseåŒæœŸãƒ­ã‚¸ãƒƒã‚¯ ==========
async function syncToFirestore() {
    if (!userUid) return;
    try {
        await db.collection("budgets").doc(userUid).set(data, { merge: true });
    } catch (e) {
        saveLocalBackup();
    }
}
async function syncFromFirestore() {
    if (!userUid) return;
    try {
        const snap = await db.collection("budgets").doc(userUid).get();
        if (snap.exists) data = snap.data() || {};
        else data = {};
        updateDisplay();
    } catch (e) {
        loadLocalBackup();
        updateDisplay();
    }
}
function saveLocalBackup() {
    localStorage.setItem("backup_"+userUid, JSON.stringify(data));
}
function loadLocalBackup() {
    let s = localStorage.getItem("backup_"+userUid);
    if (s) data = JSON.parse(s);
}
async function flushOfflineQueue() {}

// ========== èªè¨¼ ==========
async function register() {
    const email = document.getElementById("registerUsername").value.trim();
    const pw = document.getElementById("registerPassword").value;
    const pw2 = document.getElementById("registerPasswordConfirm").value;
    if (!email || !pw || !pw2) return alert("ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    if (pw !== pw2) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“");
    try {
        await auth.createUserWithEmailAndPassword(email, pw);
        alert("ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
        showLogin();
    } catch (e) { alert("ç™»éŒ²ã‚¨ãƒ©ãƒ¼: "+e.message); }
}
async function login() {
    const email = document.getElementById("loginUsername").value.trim();
    const pw = document.getElementById("loginPassword").value;
    if (!email || !pw) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");
    try {
        const userCred = await auth.signInWithEmailAndPassword(email, pw);
        // ä»¥é™ onAuthStateChanged ã§è‡ªå‹•é·ç§»
    } catch (e) { alert("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: "+e.message); }
}
async function logout() {
    if (!confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
    await syncToFirestore();
    await auth.signOut();
}
auth.onAuthStateChanged(async user => {
    if (user) {
        currentUser = user;
        userUid = user.uid;
        document.getElementById("currentUser").textContent = user.email;
        await syncFromFirestore();
        currentMonth = localStorage.getItem(LOCAL_MONTH_KEY) || getMonthKey(new Date());
        updateDisplay();
        showMainApp();
        await flushOfflineQueue();
    } else {
        currentUser = userUid = null;
        showLogin();
    }
});

// ========== ç”»é¢é·ç§» ==========
function showLogin() {
    document.getElementById('loginScreen').style.display = 'block';
    document.getElementById('registerScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'none';
}
function showRegister() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('registerScreen').style.display = 'block';
    document.getElementById('mainApp').style.display = 'none';
}
function showMainApp() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('registerScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    showTab('summary');
}

// ========== ã‚¿ãƒ–åˆ‡æ›¿ ==========
function showTab(tab) {
    ['summary', 'income', 'budget', 'expense', 'weekly', 'settings'].forEach(t => {
        document.getElementById(t + 'Tab').style.display = (t === tab) ? 'block' : 'none';
        const btns = document.getElementsByClassName('tab-btn');
        for (let btn of btns) {
            if (btn.textContent.includes(
                tab === 'summary' ? 'æ¦‚è¦' :
                    tab === 'income' ? 'åå…¥' :
                        tab === 'budget' ? 'äºˆç®—' :
                            tab === 'expense' ? 'æ”¯å‡º' :
                                tab === 'weekly' ? 'é€±æ¬¡' :
                                    tab === 'settings' ? 'è¨­å®š' : '')) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        }
    });
    if (tab === 'income') renderIncomeList();
    if (tab === 'budget') renderBudgetList();
    if (tab === 'expense') { renderExpenseCategoryOptions(); updateExpenseList(); }
    if (tab === 'weekly') updateWeeklyReport();
    if (tab === 'settings') document.getElementById('currentStartDay').textContent = getMonthStartDay();
    updateDisplay();
}

// ========== ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ– ==========
function getDefaultConfig() {
    return {
        income: [
            { name: 'ä»•é€ã‚Š', amount: 50000 },
            { name: 'ã‚¢ãƒ«ãƒã‚¤ãƒˆ', amount: 100000 }
        ],
        budget: {
            fixed: [
                { name: 'é€šä¿¡è²»', amount: 8500 },
                { name: 'æ°´é“å…‰ç†±è²»', amount: 13000 },
                { name: 'ã‚µãƒ–ã‚¹ã‚¯', amount: 13000 }
            ],
            saving: [
                { name: 'ç©ç«‹NISA', amount: 20000 },
                { name: 'æµ·å¤–æ—…è¡Œ', amount: 17000 },
                { name: 'ã‚«ãƒ¡ãƒ©', amount: 4000 }
            ],
            variable: [
                { name: 'é£Ÿè²»', amount: 27000 },
                { name: 'äº¤é€šè²»', amount: 11000 },
                { name: 'è¶£å‘³è²»', amount: 11000 },
                { name: 'äº¤éš›è²»', amount: 11000 },
                { name: 'æ—¥ç”¨å“è²»', amount: 6000 },
                { name: 'äºˆå‚™è²»', amount: 10000 }
            ]
        },
        expenses: []
    };
}
function initializeMonth(monthKey) {
    if (!data[monthKey]) {
        data[monthKey] = JSON.parse(JSON.stringify(getDefaultConfig()));
        syncToFirestore();
    }
}

// ========== åå…¥ã®è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ ==========
function renderIncomeList() {
    initializeMonth(currentMonth);
    const list = data[currentMonth].income;
    let html = '';
    list.forEach((item, idx) => {
        html += `
        <div class="input-group">
            <input type="text" value="${item.name}" onchange="editIncomeName(${idx},this.value)" style="width:40%;">
            <input type="number" value="${item.amount}" onchange="editIncomeAmount(${idx},this.value)" style="width:35%;margin-left:4px;">
            <button class="delete-btn" onclick="deleteIncomeCategory(${idx})">å‰Šé™¤</button>
        </div>`;
    });
    document.getElementById('incomeList').innerHTML = html;
    syncToFirestore();
}
function editIncomeName(idx, val) {
    data[currentMonth].income[idx].name = val;
    syncToFirestore(); renderIncomeList();
}
function editIncomeAmount(idx, val) {
    data[currentMonth].income[idx].amount = parseFloat(val) || 0;
    syncToFirestore(); renderIncomeList();
}
function addIncomeCategory() {
    data[currentMonth].income.push({ name: 'æ–°è¦é …ç›®', amount: 0 });
    syncToFirestore(); renderIncomeList();
}
function deleteIncomeCategory(idx) {
    if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        data[currentMonth].income.splice(idx, 1);
        syncToFirestore(); renderIncomeList();
    }
}

// ========== äºˆç®—ã‚«ãƒ†ã‚´ãƒªç·¨é›† ==========
function renderBudgetList() {
    initializeMonth(currentMonth);
    ['fixed', 'saving', 'variable'].forEach(group => {
        let html = '';
        data[currentMonth].budget[group].forEach((cat, idx) => {
            html += `<div class="category-manage">
            <input type="text" value="${cat.name}" onchange="editBudgetCategoryName('${group}',${idx},this.value)" style="width:45%;">
            <input type="number" value="${cat.amount}" onchange="editBudgetCategoryAmount('${group}',${idx},this.value)" style="width:35%;">
            <button class="delete-btn" onclick="deleteBudgetCategory('${group}',${idx})">å‰Šé™¤</button>
            </div>`;
        });
        document.getElementById('budget' + (group[0].toUpperCase() + group.slice(1))).innerHTML = html;
    });
    syncToFirestore();
}
function editBudgetCategoryName(group, idx, val) {
    data[currentMonth].budget[group][idx].name = val;
    syncToFirestore(); renderBudgetList();
}
function editBudgetCategoryAmount(group, idx, val) {
    data[currentMonth].budget[group][idx].amount = parseFloat(val) || 0;
    syncToFirestore(); renderBudgetList();
}
function addBudgetCategory(group) {
    data[currentMonth].budget[group].push({ name: 'æ–°è¦', amount: 0 });
    syncToFirestore(); renderBudgetList();
}
function deleteBudgetCategory(group, idx) {
    if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        data[currentMonth].budget[group].splice(idx, 1);
        syncToFirestore(); renderBudgetList();
    }
}

// ========== æ”¯å‡ºå…¥åŠ› ==========
function renderExpenseCategoryOptions() {
    initializeMonth(currentMonth);
    let opts = [];
    ['fixed', 'saving', 'variable'].forEach(g => {
        opts = opts.concat(data[currentMonth].budget[g].map(cat => cat.name));
    });
    let html = opts.map(cat => `<option value="${cat}">${cat}</option>`).join('');
    document.getElementById('expenseCategory').innerHTML = html;
}
function addExpense() {
    let d = document.getElementById('expenseDate').value;
    let cat = document.getElementById('expenseCategory').value;
    let amt = parseFloat(document.getElementById('expenseAmount').value) || 0;
    let memo = document.getElementById('expenseMemo').value;
    if (!d || !cat || !amt) return alert('æ—¥ä»˜ãƒ»ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ»é‡‘é¡ã¯å¿…é ˆ');
    let date = new Date(d + 'T12:00:00');
    let monthKey = getMonthKey(date);
    initializeMonth(monthKey);
    data[monthKey].expenses.push({ date: date.toISOString(), category: cat, amount: amt, memo, week: getWeekNumber(date, monthKey) });
    syncToFirestore();
    document.getElementById('expenseDate').value = '';
    document.getElementById('expenseAmount').value = '';
    document.getElementById('expenseMemo').value = '';
    renderExpenseCategoryOptions();
    updateExpenseList();
    updateDisplay();
    alert('æ”¯å‡ºã‚’è¿½åŠ ã—ã¾ã—ãŸ');
}
function updateExpenseList() {
    initializeMonth(currentMonth);
    let arr = [...data[currentMonth].expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
    let html = arr.map((ex, idx) => {
        let d = new Date(ex.date);
        return `<div class="expense-item">
            <span><strong>${d.getMonth() + 1}/${d.getDate()}</strong> ${ex.category} Â¥${ex.amount.toLocaleString()} ${ex.memo ? '<span class="small">- ' + ex.memo + '</span>' : ''}</span>
            <button class="delete-btn" onclick="deleteExpense(${idx})">å‰Šé™¤</button>
        </div>`;
    }).join('');
    document.getElementById('expenseList').innerHTML = html;
}
function deleteExpense(idx) {
    if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        data[currentMonth].expenses.splice(idx, 1);
        syncToFirestore();
        updateExpenseList();
        updateDisplay();
    }
}

// ========== æœˆ/é€±ã‚µãƒãƒªãƒ¼ãƒ»é€²æ—ãƒ»ãƒ¬ãƒãƒ¼ãƒˆ ==========
function updateDisplay() {
    initializeMonth(currentMonth);
    localStorage.setItem(LOCAL_MONTH_KEY, currentMonth);
    let range = getMonthRange(currentMonth);
    document.getElementById('currentMonth').textContent =
        `${range.start.getFullYear()}å¹´${range.start.getMonth() + 1}æœˆ${range.start.getDate()}æ—¥ã€œ${range.end.getMonth() + 1}æœˆ${range.end.getDate()}æ—¥`;
    let incomeSum = data[currentMonth].income.reduce((a, b) => a + b.amount, 0);
    let budgets = ['fixed', 'saving', 'variable'].flatMap(g => data[currentMonth].budget[g]);
    let budgetSum = budgets.reduce((a, b) => a + b.amount, 0);
    let expenseSum = data[currentMonth].expenses.reduce((a, b) => a + b.amount, 0);
    let remain = incomeSum - expenseSum;
    document.getElementById('totalIncome').textContent = incomeSum.toLocaleString();
    document.getElementById('totalBudget').textContent = budgetSum.toLocaleString();
    document.getElementById('totalExpense').textContent = expenseSum.toLocaleString();
    document.getElementById('remainingBudget').textContent = remain.toLocaleString();
    let remCard = document.getElementById('remainingCard');
    remCard.style.background = remain < 0 ? 'linear-gradient(135deg,#EF4444,#DC2626)' : '#F4F4FC';
    let tbody = document.getElementById('categorySummary');
    tbody.innerHTML = '';
    budgets.forEach(cat => {
        let catExpSum = data[currentMonth].expenses.filter(e => e.category === cat.name).reduce((a, b) => a + b.amount, 0);
        let rem = cat.amount - catExpSum;
        let percent = cat.amount ? catExpSum / cat.amount * 100 : 0;
        let row = tbody.insertRow();
        row.innerHTML = `
          <td>${cat.name}</td>
          <td>Â¥${cat.amount.toLocaleString()}</td>
          <td>Â¥${catExpSum.toLocaleString()}</td>
          <td>Â¥${rem.toLocaleString()}</td>
          <td><div class="progress-bar"><div class="progress-fill" style="width:${Math.min(percent, 100)}%"></div></div><span class="small">${percent.toFixed(1)}%</span></td>
        `;
    });
    updateAlerts();
}
function updateAlerts() {
    let monthData = data[currentMonth];
    let alerts = '';
    let budgets = ['fixed', 'saving', 'variable'].flatMap(g => monthData.budget[g]);
    budgets.forEach(cat => {
        let catExp = monthData.expenses.filter(e => e.category === cat.name).reduce((a, b) => a + b.amount, 0);
        if (catExp > cat.amount) {
            alerts += `<div class="alert alert-warning">âš ï¸ ${cat.name}ãŒäºˆç®—ã‚’${(catExp - cat.amount).toLocaleString()}å††è¶…é</div>`;
        }
    });
    document.getElementById('alerts').innerHTML = alerts;
}
function updateWeeklyReport() {
    let cats = ['fixed', 'saving', 'variable'].flatMap(g => data[currentMonth].budget[g]).map(c => c.name);
    let tbody = document.getElementById('weeklyReport'); tbody.innerHTML = '';
    let wdata = {};
    cats.forEach(cat => wdata[cat] = { weeks: [0, 0, 0, 0, 0], total: 0 });
    data[currentMonth].expenses.forEach(ex => {
        let week = ex.week - 1;
        if (cats.includes(ex.category)) {
            wdata[ex.category].weeks[week] += ex.amount;
            wdata[ex.category].total += ex.amount;
        }
    });
    cats.forEach(cat => {
        let row = tbody.insertRow();
        row.innerHTML = `
            <td>${cat}</td>
            <td>Â¥${wdata[cat].weeks[0].toLocaleString()}</td>
            <td>Â¥${wdata[cat].weeks[1].toLocaleString()}</td>
            <td>Â¥${wdata[cat].weeks[2].toLocaleString()}</td>
            <td>Â¥${wdata[cat].weeks[3].toLocaleString()}</td>
            <td>Â¥${wdata[cat].weeks[4].toLocaleString()}</td>
            <td><strong>Â¥${wdata[cat].total.toLocaleString()}</strong></td>
        `;
    });
    // é€±åˆè¨ˆè¡Œ
    let totalRow = tbody.insertRow();
    totalRow.className = "week-total-row";
    let weekTotals = [0,0,0,0,0], grandTotal = 0;
    cats.forEach(cat => {
        for (let i = 0; i < 5; i++) weekTotals[i] += wdata[cat].weeks[i];
        grandTotal += wdata[cat].total;
    });
    totalRow.innerHTML = `
        <td>é€±åˆè¨ˆ</td>
        <td>Â¥${weekTotals[0].toLocaleString()}</td>
        <td>Â¥${weekTotals[1].toLocaleString()}</td>
        <td>Â¥${weekTotals[2].toLocaleString()}</td>
        <td>Â¥${weekTotals[3].toLocaleString()}</td>
        <td>Â¥${weekTotals[4].toLocaleString()}</td>
        <td>Â¥${grandTotal.toLocaleString()}</td>
    `;
}

// ========== æœˆåˆ‡ã‚Šæ›¿ãˆ/ä»Šæœˆ/æœˆåˆè¨­å®š ==========
function changeMonth(diff) {
    let [y, m] = currentMonth.split("-").map(Number);
    let startDay = getMonthStartDay();
    let newDate = new Date(y, m - 1 + diff, startDay);
    currentMonth = getMonthKey(newDate);
    updateDisplay();
    renderIncomeList();
    renderBudgetList();
    renderExpenseCategoryOptions();
    updateExpenseList();
    updateWeeklyReport();
}
function goToToday() {
    currentMonth = getMonthKey(new Date());
    updateDisplay();
    renderIncomeList();
    renderBudgetList();
    renderExpenseCategoryOptions();
    updateExpenseList();
    updateWeeklyReport();
}
function changeMonthStartDay() {
    let day = prompt("æœˆã®é–‹å§‹æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ1~28ï¼‰", getMonthStartDay());
    day = parseInt(day);
    if (day >= 1 && day <= 28) {
        setMonthStartDay(day);
        // æœˆåˆå¤‰æ›´ã§æœˆã¾ãŸããƒ­ã‚¸ãƒƒã‚¯ãŒå¤‰ã‚ã‚‹
        currentMonth = getMonthKey(new Date());
        updateDisplay();
        renderIncomeList();
        renderBudgetList();
        renderExpenseCategoryOptions();
        updateExpenseList();
        updateWeeklyReport();
    } else {
        alert("1ã€œ28ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    }
}

// ========== ãƒ‡ãƒ¼ã‚¿å…¨ãƒªã‚»ãƒƒãƒˆ ==========
function resetAllData() {
    if (confirm('å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã—ã¾ã™ã€‚å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
        db.collection("budgets").doc(userUid).delete().then(()=>{
            data = {};
            alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã§åˆæœŸåŒ–ã•ã‚Œã¾ã™ã€‚");
            location.reload();
        });
    }
}

// ========== åˆæœŸç”»é¢çŠ¶æ…‹ãƒ»è‡ªå‹•æœˆé·ç§» ==========
window.onload = function() {
    if (!localStorage.getItem(LOCAL_STARTDAY_KEY)) setMonthStartDay(15);
};

</script>
</body>
</html>
